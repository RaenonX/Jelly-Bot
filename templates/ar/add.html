{% extends "base/base.html" %}
{% load i18n %}
{% load static %}
{% load utils %}

<!-- INCOMPLETE: When CD > 20 sec, no force webpage over a lot of lines -->

{% block content %}
    {% with ar_prfx=static_keys_param.AutoReply %}
        {% csrf_token %}
        <div class="container">
            <form class="enable-login d-none needs-validation" novalidate id="arForm">
                <div class="row">
                    <div class="col-lg-6">
                        <input type="hidden" id="response-count" value="1">

                        {% include "ar/add-main.html" %}
                        {% include "ar/add-notes.html" %}
                    </div>

                    <div class="col-lg-6">
                        {% include "ar/add-props.html" %}
                        {% include "ar/add-reg.html" %}
                    </div>
                </div>

                <hr>

                <div class="text-right">
                    <div class="col text-danger d-none" id="inputFailed">{% trans "Recheck your inputs." %}</div>
                    <div class="col text-success d-none" id="submitSuccess">{% trans "Submission Succeed." %}</div>
                    <div class="col text-danger d-none" id="submitFailed">{% trans "Submission Failed." %}</div>
                    <div class="col d-inline">
                        <span><a href="{% url "page.doc.code.insert" %}"
                                 target="_blank">{% trans "Insert Outcome Code:" %}</a></span>
                        <h5 class="d-inline"><a id="arCodeLink" data-prefix="{% url "page.doc.code.insert" %}#"><code
                                id="arCode">-</code></a></h5>
                    </div>
                    <div class="col d-inline">
                        <button type="button" class="btn btn-outline-dark arSubmit"
                                disabled>{% trans "Submit" %}</button>
                    </div>
                </div>
                <div class="m-3 text-right">
                    <small>{% trans "Last Submission Status Updated on " %}</small><span id="arSubmitTime">-</span>
                </div>
            </form>
        </div>
    {% endwith %}
{% endblock %}

{% block ex-script %}
    <script type="text/javascript">
        let tagSplittor = "{{ tag_splittor }}";

        function checkChannelMembership(platVal, channel, fnOnLoad) {
            if (channel === "") {
                fnOnLoad(false);
            } else {
                let url = `{% url "api.id.channel.data" %}?{{ static_keys_param.DataQuery.Channel.PLATFORM }}=${platVal}&{{ static_keys_param.DataQuery.Channel.CHANNEL_TOKEN }}=${channel}&{{ static_keys_param.LOCAL_REFER }}=true`;

                let xhr = new XMLHttpRequest();
                xhr.open("GET", url);
                xhr.responseType = "json";
                xhr.onload = function () {
                    let success = xhr.response["{{ static_keys_result.SUCCESS }}"];

                    fnOnLoad(success);
                    console.log(xhr.response);
                    if (success) {
                        checkAccessPinnedPermission(xhr.response["{{ static_keys_result.RESULT }}"]["{{ static_keys_result.Results.MODEL }}"]["_id"].substring(10, 34));
                    } else {
                        enablePinnedModuleAccess(false);
                    }
                };
                xhr.send();
            }
        }

        function collectData() {
            let param = new URLSearchParams();

            // Attach KEYWORD and RESPONSES
            $("div.content-check:not(.d-none)").find("textarea").each(function () {
                param.append($(this).data("postkey"), $(this).val());
            });

            // Attach KEYWORD TYPES and RESPONSE TYPES
            $("div.content-check:not(.d-none) .ar-type").each(function () {
                param.append($(this).data("postkey"), $(this).val());
            });

            if (regId === "arChannel") {
                // Attach CHANNEL_TOKEN, PLATFORM
                $("input#arChannelID, select#arPlatform option:selected").each(function () {
                    param.append($(this).data("postkey"), $(this).val());
                });
            } else if (regId === "arMember") {
                // Attach CHANNEL_TOKEN, PLATFORM
                $("span#channelPlatform, code#channelToken").each(function () {
                    param.append($(this).data("postkey"), $(this).val());
                });
            }

            // Attach PRIVATE, PIN, COOLDOWN
            $("input#arPrivate, input#arPinned, input#arCoolDown").each(function () {
                param.append($(this).data("postkey"), $(this).val());
            });

            // Attach TAGS
            param.append("{{ static_keys_param.AutoReply.TAGS }}", selectedTags.join(","));

            // Attach CREATOR_TOKEN flag
            param.append("{{ static_keys_param.AutoReply.API_TOKEN }}", "{{ api_token }}");

            // Attach LOCAL_REFER flag
            param.append("{{ static_keys_param.LOCAL_REFER }}", "true");

            return param;
        }

        function submitData(onLoadCallback) {
            let url;
            if (regId === "arChannel" || regId === "arMember") {
                url = "{% url "api.ar.add" %}";
            } else if (regId === "arToken") {
                url = "{% url "api.ar.add_token" %}"
            }

            let xhr = new XMLHttpRequest();
            xhr.open("POST", url);
            xhr.responseType = "json";
            xhr.onload = function () {
                hideAllSubmitMsg();
                try {
                    updateArCode(xhr.response["{{ static_keys_result.RESULT }}"]["{{ static_keys_result.Results.OUTCOME }}"]);
                } catch (error) {
                    onSubmissionFailed()
                }

                onLoadCallback(xhr.response);
            };
            xhr.onerror = onSubmissionFailed;
            xhr.send(collectData());
        }

        function displayToken(response) {
            if (response.hasOwnProperty("{{ static_keys_result.RESULT }}") &&
                response["{{ static_keys_result.RESULT }}"].hasOwnProperty("{{ static_keys_result.TokenActionResponse.TOKEN }}")) {
                $("code#arTokenReturn").text(response["{{ static_keys_result.RESULT }}"]["{{ static_keys_result.TokenActionResponse.TOKEN }}"]);
            } else {
                console.log(`Token Display Failed. Token: ${response["{{ static_keys_result.RESULT }}"]["{{ static_keys_result.TokenActionResponse.TOKEN }}"]}`)
            }
        }

        function validateContent(type, content, fnOnLoad) {
            let url = `{% url "api.ar.validate" %}?{{ static_keys_param.Validation.CONTENT }}=${encodeURIComponent(content)}&{{ static_keys_param.Validation.CONTENT_TYPE }}=${type}`;

            let xhr = new XMLHttpRequest();
            xhr.open("GET", url);
            xhr.responseType = "json";
            xhr.onload = function () {
                let success = xhr.response.{{ static_keys_result.SUCCESS }} || false;
                let result = xhr.response.{{ static_keys_result.RESULT }} || false;

                fnOnLoad(success, result);
            };
            xhr.send();
        }

        function searchTagsByPopularity(word, onFound, onNotFound, onResult) {
            let url = `{% url "api.ar.tag.pop" %}?{{ static_keys_param.DataQuery.KEYWORD }}=${encodeURIComponent(word)}`;

            let xhr = new XMLHttpRequest();
            xhr.open("GET", url);
            xhr.responseType = "json";
            xhr.onload = function () {
                let resp = xhr.response["{{ static_keys_result.RESULT }}"];

                onResult();
                if (resp.length > 0) {
                    onFound(resp);
                } else {
                    onNotFound();
                }
            };
            xhr.send();
        }

        function checkAccessPinnedPermission(coid) {
            let url = `{% url "api.id.perm" %}?{{ static_keys_param.Manage.Channel.CHANNEL_OID }}=${coid}&{{ static_keys_param.LOCAL_REFER }}=true`;

            let xhr = new XMLHttpRequest();
            xhr.open("GET", url);
            xhr.responseType = "json";
            xhr.onload = function () {
                enablePinnedModuleAccess(xhr.response["{{ static_keys_result.RESULT }}"].includes({{ perm_pin_access }}));
            };
            xhr.send();
        }
    </script>
    <script src="{% static "js/ar/add.js" %}" type="text/javascript"></script>
    <script src="{% static "js/ar/artag.js" %}" type="text/javascript"></script>
{% endblock %}